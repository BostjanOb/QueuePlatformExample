<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QueuePlatform example</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.3.1/css/bulma.min.css"/>
</head>
<body>
<div id="app" class="container" style="padding-top: 40px">
    <div class="columns">
        <div class="column">
            <div class="notification is-warning">
                <form @submit.prevent="send">
                    <label class="label">Task</label>
                    <p class="control">
                        <span class="select">
                            <select v-model="task">
                                <option value="reverse">Reverse</option>
                                <option value="fibonacci">Fibonacci</option>
                                <option value="encoder">Encoder</option>
                                <option value="arithmetic">Arithmetic</option>
                                <option value="slowtask">Slow Task (10 sec)</option>
                            </select>
                        </span>
                    </p>
                    <label class="label">Params</label>
                    <p class="control">
                        <input class="input" type="text" placeholder="params" v-model="params">
                    </p>
                    <button :disabled="task == null" type="submit" class="button is-primary">Queue task</button>
                </form>
            </div>
        </div>
        <div class="column is-three-quarters">
            <table class="table">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Name</th>
                        <th>Params</th>
                        <th>Status</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in tasks">
                        <td>{{ t.id }}</td>
                        <td>{{ t.name }}</td>
                        <td>{{ t.params }}</td>
                        <td>{{ t.status }}</td>
                        <td>{{ t.result }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.10/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.3/axios.min.js"></script>
<script>
	new Vue({
		el: '#app',
		data: {
			task: "reverse",
			params: '',
			tasks: []
		},

		methods: {
			send() {
				axios.post('/queue.php', `{"jsonrpc":"2.0","method":"queueTask","id":1,"params":["${this.task}", "${this.params}"]}`)
					.then(({data}) => {
						this.tasks.unshift(data.result);
					});
			}
		},

        mounted() {
			setInterval(() => {
				this.tasks.forEach((task) => {
					if ( task.status != 'completed' ) {
						axios.post('/queue.php', `{"jsonrpc":"2.0","method":"getTask","id":1,"params":[${task.id}]}`)
							.then(({data}) => {
								task.status = data.result.status;
								task.result = data.result.result;
							});
					}
                });
            }, 2000);
        }

	});
</script>
</html>